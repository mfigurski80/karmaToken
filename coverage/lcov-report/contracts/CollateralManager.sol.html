<!DOCTYPE html><html lang="en"><head>
    <title>Code coverage report for contracts/CollateralManager.sol</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>.coverage-summary .sorter{background-image:url(../sort-arrow-sprite.png)}
</style>
</head>
<body>
<div class="wrapper">
  <div class="pad1">
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> CollateralManager.sol
    </h1>
    <div class="clearfix">
      <div class="fl pad1y space-right2">
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class="fraction">0/35</span>
      </div>
      <div class="fl pad1y space-right2">
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class="fraction">0/12</span>
      </div>
      <div class="fl pad1y space-right2">
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class="fraction">0/5</span>
      </div>
      <div class="fl pad1y space-right2">
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class="fraction">0/35</span>
      </div>
    </div>
  </div>
  <div class="status-line low"></div>
<pre><table class="coverage">
<tbody><tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;
&nbsp;
import "./LifecycleManager.sol";
import "./CurrencyManager.sol";
import "./LBondManager.sol";
&nbsp;
struct Collateral {
    uint256 amountOrId;
    uint256 currencyRef;
}
&nbsp;
/**
 * @title ðŸ«€ CollateralManager contract for handling bond
 * collateral.
 */
contract CollateralManager is LifecycleManager {
    using LBondManager for bytes32;
&nbsp;
    /**
     * @notice Mapping holding collaterals associated with
     * each bond id
     */
    mapping(uint256 =&gt; Collateral[]) public collateral;
&nbsp;
    // TODO: add field for amount or nft id?
    /// @notice New collateral has been attached to bond
    event CollateralAdded(
        uint256 bondId,
        uint256 collateralId,
        CurrencyType collateralType
    );
    /// @notice Collateral has been released from bond
    event CollateralReleased(uint256 bondId, uint256 collateralId, address to);
&nbsp;
<span class="fstat-no" title="function not covered">    constructor(</span>
        string memory name,
        string memory symbol,
        string memory uri
    )
        LifecycleManager(name, symbol, uri) // solhint-disable-next-line no-empty-blocks
    {}
&nbsp;
    /**
     * @notice Add a generic currency collateral to a bond
     * @param id Id of bond to attach collateral to
     * @param currencyRef Id of currency collateral is
     * denominated in
     * @param valueOrId Either the amount of tokens to attach,
     * or the NFT id being attached (depending on currency)
     */
<span class="fstat-no" title="function not covered">    function addCollateral(</span>
        uint256 id,
        uint256 currencyRef,
        uint256 valueOrId
    ) external payable {
        // TODO: add from paramenter?
<span class="cstat-no" title="statement not covered">        collateral[id].push(Collateral(valueOrId, currencyRef))</span>;
<span class="cstat-no" title="statement not covered">        CurrencyType typ = CurrencyType.Ether;</span>
<span class="cstat-no" title="statement not covered">        if (currencyRef == 0) {</span>
            // ether special case
<span class="cstat-no" title="statement not covered">            assert(msg.value == valueOrId)</span>;
        } else {
<span class="cstat-no" title="statement not covered">            Currency storage c = currencies[currencyRef];</span>
<span class="cstat-no" title="statement not covered">            typ = c.currencyType</span>;
<span class="cstat-no" title="statement not covered">            _transferGenericCurrency(</span>
                c,
                msg.sender,
                address(this),
                valueOrId,
                ""
            );
        }
<span class="cstat-no" title="statement not covered">        emit CollateralAdded(id, collateral[id].length - 1, typ);</span>
    }
&nbsp;
    /**
     * @dev Internal method to check if user is allowed
     * to release collateral from a bond
     * @param bondId Id of bond to check for
     * @param operator Account address to authorize
     */
<span class="fstat-no" title="function not covered">    function _isAuthorizedToReleaseCollateral(uint256 bondId, address operator)</span>
        internal
        view
        returns (bool)
    {
<span class="cstat-no" title="statement not covered">        Bond memory b;</span>
        // Check for default + bond ownership
<span class="cstat-no" title="statement not covered">        b = bonds[bondId * 2].fillBondFromAlpha(b)</span>;
<span class="cstat-no" title="statement not covered">        bool isOwner = _ownerOrOperatorOf(bondId, _owners[bondId], operator);</span>
<span class="cstat-no" title="statement not covered">        if (b.flag &amp;&amp; isOwner) <span class="cstat-no" title="statement not covered">return true;</span></span>
        // Check for completed + bond minter
<span class="cstat-no" title="statement not covered">        b = bonds[bondId * 2 + 1].fillBondFromBeta(b)</span>;
<span class="cstat-no" title="statement not covered">        bool isMinter = _minterOrOperatorOf(b.minter, operator);</span>
<span class="cstat-no" title="statement not covered">        return (b.curPeriod &gt; b.nPeriods &amp;&amp; isMinter);</span>
    }
&nbsp;
    /**
     * @notice Release last collateral attached to specified bonds ids
     * @dev Method is optimized to memoize the 'previous' bond and
     * currency used. If possible, sort incoming lists by bondIds and
     * by related currencyIds.
     * @param bondIds Integer array of bondIds to release collateral for
     * @param to address to direct all collaterals to
     * @param data bytes to forward with each transfer
     */
<span class="fstat-no" title="function not covered">    function safeBatchReleaseCollaterals(</span>
        uint256[] memory bondIds,
        address to,
        bytes calldata data
    ) public {
<span class="cstat-no" title="statement not covered">        uint256 lastAuthorizedBond = 2**256 - 1;</span>
<span class="cstat-no" title="statement not covered">        uint256 lastCurrencyRef = 2**256 - 1;</span>
<span class="cstat-no" title="statement not covered">        Currency storage currency = currencies[0];</span> // TODO: figure out storage pointer
<span class="cstat-no" title="statement not covered">        for (uint256 i = 0; i &lt; bondIds.length; i++) {</span>
<span class="cstat-no" title="statement not covered">            uint256 bondId = bondIds[i];</span>
            // Check if this is an un-cached bond?
<span class="cstat-no" title="statement not covered">            if (</span>
                lastAuthorizedBond != bondId || lastAuthorizedBond == 2**256 - 1
            ) {
                // It is! Authorize new release
<span class="cstat-no" title="statement not covered">                require(</span>
                    _isAuthorizedToReleaseCollateral(bondId, msg.sender),
                    "CollateralManager: unauthorized to release collateral"
                );
<span class="cstat-no" title="statement not covered">                lastAuthorizedBond = bondId</span>;
            }
            // Get bond collateral (last in array), remove from storage
<span class="cstat-no" title="statement not covered">            uint256 collateralId = collateral[bondId].length - 1;</span>
<span class="cstat-no" title="statement not covered">            Collateral memory c = collateral[bondId][collateralId];</span>
<span class="cstat-no" title="statement not covered">            collateral[bondId].pop()</span>;
<span class="cstat-no" title="statement not covered">            require(</span>
                c.amountOrId &gt; 0,
                "CollateralManager: this collateral has already been released"
            );
            // Check if Collateral refers to a un-cached currency
<span class="cstat-no" title="statement not covered">            if (</span>
                lastCurrencyRef != c.currencyRef ||
                lastCurrencyRef == 2**256 - 1
            ) {
                // It does! Re-load cached currency
<span class="cstat-no" title="statement not covered">                currency = currencies[c.currencyRef]</span>;
<span class="cstat-no" title="statement not covered">                lastCurrencyRef = c.currencyRef</span>;
            }
            // Transfer collateral
<span class="cstat-no" title="statement not covered">            _transferGenericCurrency(</span>
                currency,
                address(this),
                to,
                c.amountOrId,
                data
            );
<span class="cstat-no" title="statement not covered">            emit CollateralReleased(bondId, collateralId, to);</span>
        }
    }
&nbsp;
    /**
     * @inheritdoc LifecycleManager
     * @notice Collateral must be entirely released to allow bond destruction
     */
<span class="fstat-no" title="function not covered">    function destroyBond(uint256 id) public override onlyValidOperator(id) {</span>
<span class="cstat-no" title="statement not covered">        assert(collateral[id].length == 0)</span>;
        delete collateral[id];
<span class="cstat-no" title="statement not covered">        super.destroyBond(id)</span>;
    }
}
&nbsp;</pre></td></tr>
</tbody></table></pre>
<div class="push"></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class="footer quiet pad2 space-top1 center small">
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Jul 15 2022 16:09:45 GMT+0000 (Coordinated Universal Time)
</div>

<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>


</body></html>